name: "Mitigated: Cross-Job Secret Leak"

on:
  workflow_dispatch:
    inputs:
      wait_seconds:
        description: "Seconds to wait (rotation window)"
        required: false
        default: "30"

jobs:
  capture:
    runs-on: ubuntu-latest
    outputs:
      encoded: ${{ steps.encode.outputs.value }}
    steps:
      - name: Print secret (should be masked)
        env:
          SECRET: ${{ secrets.TEST_SECRET }}
        run: |
          echo "CAPTURE_SECRET_VALUE: $SECRET"

      - name: Encode and set output
        id: encode
        env:
          SECRET: ${{ secrets.TEST_SECRET }}
        run: |
          ENCODED=$(printf '%s' "$SECRET" | base64 | base64)
          echo "value=$ENCODED" >> "$GITHUB_OUTPUT"
          echo "Secret captured and double-base64 encoded as job output"

      - name: Wait for rotation
        run: |
          echo "Waiting ${{ github.event.inputs.wait_seconds }}s..."
          sleep "${{ github.event.inputs.wait_seconds }}"

  print:
    needs: capture
    runs-on: ubuntu-latest
    steps:
      - name: Print current secret (should be masked)
        env:
          SECRET: ${{ secrets.TEST_SECRET }}
        run: |
          echo "PRINT_CURRENT_SECRET: $SECRET"

      - name: Decode and print
        env:
          ENCODED: ${{ needs.capture.outputs.encoded }}
        run: |
          DECODED=$(printf '%s' "$ENCODED" | base64 -d | base64 -d)
          echo "SECRET_VALUE: $DECODED"
          echo "SECRET_HEX: $(printf '%s' "$DECODED" | xxd -p | tr -d '\n')"
